---
- name: Copy kubeadm.yaml file
  ansible.builtin.template:
    src: "./templates/kubeadm.yaml"
    dest: "/etc/kubernetes"


# - name: Copy 10-kubeadm.conf file
#   ansible.builtin.template:
#     src: "./templates/10-kubeadm.conf"
#     dest: "/etc/systemd/system/kubelet.service.d"


# - name: initialize the cluster
#   command: kubeadm init --config /etc/kubernetes/aws.yaml --upload-certs > cluster_initialized.txt
#   args:
#     chdir: $HOME
#     creates: cluster_initialized.txt

- name: initialize the cluster
  shell: kubeadm init --config /etc/kubernetes/kubeadm.yaml
  register: kubeadm_init
  # ignore_errors: yes

- name: Print join commands
  ansible.builtin.debug:
    var: kubeadm_init.stdout 

- pause:
    prompt: "Validate kubeadm init"

- name: Store init output
  action: copy content="{{ kubeadm_init.stdout }}" dest="/etc/kubernetes/kubeadm-init.stdout"

- name: create .kube directory
  become: true
  ansible.builtin.file:
    path: $HOME/.kube
    state: directory
    mode: 0755

- name: copy admin.conf to user's kube config
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/ubuntu/.kube/config
    remote_src: yes
    owner: ubuntu

# - name: install Pod network
#   become: true
#   command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml > pod_network_setup.txt
#   args:
#     chdir: $HOME
#     creates: pod_network_setup.txt

